<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Mutfak EkranÄ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* KartlarÄ±n daha belirgin olmasÄ± iÃ§in Ã¶zel stil */
        .order-card {
            border-left: 10px solid #dc3545; /* Sol taraf kÄ±rmÄ±zÄ± Ã§izgi */
            transition: transform 0.2s;
        }
        .order-card:hover {
            transform: scale(1.02); /* Ãœzerine gelince hafif bÃ¼yÃ¼sÃ¼n */
        }
    </style>
</head>
<body class="bg-dark text-white">

<div class="container-fluid mt-4">
    <h2 class="text-center mb-4 text-warning">ğŸ‘¨â€ğŸ³ AKTÄ°F SÄ°PARÄ°ÅLER</h2>
    
    <div class="row" id="siparisKutusu">
        <div class="text-center mt-5 text-secondary">
            <h3>Åu an bekleyen sipariÅŸ yok...</h3>
        </div>
    </div>
</div>

<script>
    // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda ve her 3 saniyede bir Ã§alÄ±ÅŸtÄ±r
    window.onload = function() {
        siparisleriGetir();
        setInterval(siparisleriGetir, 3000); // 3000 milisaniye = 3 saniye
    };

    // 1. SÄ°PARÄ°ÅLERÄ° Ã‡EKME FONKSÄ°YONU
    async function siparisleriGetir() {
        try {
            const response = await fetch('/kitchen/orders');
            const siparisler = await response.json();
            
            const kutu = document.getElementById("siparisKutusu");
            
            // EÄŸer sipariÅŸ yoksa boÅŸ ekran mesajÄ± gÃ¶ster
            if (siparisler.length === 0) {
                kutu.innerHTML = '<div class="text-center mt-5 text-secondary"><h3>Åu an bekleyen sipariÅŸ yok...</h3></div>';
                return;
            }

            // Ã–nce kutuyu temizle, sonra yeniden doldur
            kutu.innerHTML = ""; 

            siparisler.forEach(siparis => {
                // Her sipariÅŸ iÃ§in iÃ§ iÃ§e HTML oluÅŸturuyoruz
                let urunListesiHTML = "";
                
                siparis.items.forEach(kalem => {
                    urunListesiHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${kalem.quantity}x</strong> ${kalem.product.name}
                                <br>
                                <small class="text-danger">${kalem.note || ""}</small>
                            </div>
                        </li>
                    `;
                });

                // KartÄ±n HTML ÅŸablonu
                const kartHTML = `
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card order-card h-100 shadow">
                            <div class="card-header bg-danger text-white d-flex justify-content-between">
                                <span>Masa: <strong>${siparis.table_no}</strong></span>
                                <span>FiÅŸ: #${siparis.id}</span>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    ${urunListesiHTML}
                                </ul>
                            </div>
                            <div class="card-footer bg-white">
                                <button onclick="hazirla(${siparis.id})" class="btn btn-success w-100 btn-lg">
                                    âœ… HAZIR
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                kutu.innerHTML += kartHTML;
            });

        } catch (error) {
            console.error("BaÄŸlantÄ± hatasÄ±:", error);
        }
    }

    // 2. DURUM GÃœNCELLEME (PUT Ä°STEÄÄ°)
    async function hazirla(siparisID) {
        const onays = confirm("Bu sipariÅŸi tamamladÄ±nÄ±z mÄ±?");
        if (onays) {
            await fetch(`/orders/${siparisID}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: "HazÄ±r" })
            });
            // Ekranda anlÄ±k yenilenmesi iÃ§in fonksiyonu hemen Ã§aÄŸÄ±r
            siparisleriGetir(); 
        }
    }
</script>

</body>
</html>